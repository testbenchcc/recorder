{% extends "base.html" %}

{% block title %}Recorder â€“ Recordings{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h4 class="mb-0">Recordings</h4>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <select class="form-select form-select-sm" id="sort-select" style="width: auto; min-width: 200px;">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="largest">Largest First</option>
        <option value="smallest">Smallest First</option>
        <option value="longest">Longest First</option>
        <option value="shortest">Shortest First</option>
      </select>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="filter-transcribed" style="cursor: pointer;">
        <label class="form-check-label" for="filter-transcribed" style="cursor: pointer; user-select: none;">
          Has Transcription
        </label>
      </div>
      <button class="btn btn-sm btn-primary" id="refresh-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
          <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
        </svg>
        Refresh
      </button>
    </div>
  </div>
  
  <div id="bulk-actions-bar" class="d-none mb-3 p-2 bg-white border rounded">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <input type="checkbox" class="form-check-input" id="select-all-checkbox">
        <label class="form-check-label" for="select-all-checkbox">
          <span id="selected-count">0</span> selected
        </label>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-secondary" id="select-all-btn">Select All</button>
        <button class="btn btn-sm btn-outline-secondary" id="select-none-btn">Select None</button>
        <button class="btn btn-sm btn-outline-primary" id="bulk-keep-local-on-btn">Keep Local</button>
        <button class="btn btn-sm btn-outline-secondary" id="bulk-keep-local-off-btn">Stop Keeping Local</button>
        <button class="btn btn-sm btn-danger" id="bulk-delete-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
          </svg>
          Delete Selected
        </button>
      </div>
    </div>
  </div>
  
  <div id="recordings-empty" class="text-center text-muted py-5" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-mic-mute mb-3" viewBox="0 0 16 16">
      <path d="M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879L5.158 2.037A3.001 3.001 0 0 1 11 3z"/>
      <path d="M9.486 10.607 5 6.12V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z"/>
    </svg>
    <p class="lead">No recordings yet</p>
  </div>
  
  <div id="recordings-grid" class="recordings-grid"></div>
  <div id="recordings-messages" class="mt-3"></div>
</div>

<audio id="player" controls class="w-100" style="display: none;"></audio>

<div
  class="modal fade"
  id="transcript-modal"
  tabindex="-1"
  aria-labelledby="transcript-modal-label"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" style="max-width: 90vw;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transcript-modal-label">Transcription</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div
          id="transcript-layout"
          class="transcript-layout"
        >
          <div
            id="transcript-controls"
            class="mb-2"
          >
            <div class="d-flex flex-wrap align-items-center gap-2">
              <label
                for="transcript-format"
                class="form-label mb-0 small me-2"
              >
                Response format
              </label>
              <select
                id="transcript-format"
                class="form-select form-select-sm"
                style="width: auto; min-width: 140px;"
              >
                <option value="json">json</option>
                <option value="text">text</option>
                <option value="srt">srt</option>
                <option value="vtt">vtt</option>
                <option value="vad_sequential">VAD + Sequential</option>
              </select>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                id="transcript-vad-redo-btn"
              >
                Regen VAD
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                id="transcript-retry-btn"
              >
                Resend
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                id="transcript-stop-btn"
                disabled
              >
                Stop
              </button>
              <div
                id="transcript-vad-options"
                class="d-flex align-items-center gap-2 ms-2"
                style="display: none;"
              >
                <div class="form-check mb-0">
                  <input
                    class="form-check-input me-1"
                    type="checkbox"
                    id="transcript-show-segment-timestamps"
                    checked
                  />
                  <label
                    class="form-check-label small"
                    for="transcript-show-segment-timestamps"
                  >
                    Show segment timestamps
                  </label>
                </div>
                <div class="form-check mb-0">
                  <input
                    class="form-check-input me-1"
                    type="checkbox"
                    id="transcript-per-response-newline"
                    checked
                  />
                  <label
                    class="form-check-label small"
                    for="transcript-per-response-newline"
                  >
                    New line per response
                  </label>
                </div>
              </div>
            </div>
            <div
              id="transcript-loading"
              class="align-items-center mt-2"
              style="display: none;"
            >
              <div
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
              ></div>
              <div class="small">
                <div id="transcript-status-line">
                  Uploading and processing audio now
                </div>
                <div id="transcript-elapsed" class="text-muted"></div>
              </div>
            </div>
            <div
              id="transcript-progress"
              class="mt-2"
              style="display: none;"
            >
              <div
                id="transcript-progress-label"
                class="small mb-1"
              ></div>
              <div class="progress" style="height: 6px;">
                <div
                  id="transcript-progress-bar"
                  class="progress-bar"
                  role="progressbar"
                  style="width: 0%;"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
            </div>
          </div>
          <div
            id="transcript-waveform-container"
            class="transcript-timeline"
          >
            <div
              id="transcript-waveform"
              class="border rounded"
            >
              <div id="transcript-waveform-inner"></div>
            </div>
          </div>
          <div
            id="transcript-content-cell"
            class="transcript-content-cell"
          >
            <div
              id="transcript-content-scroll"
              class="border rounded p-2 bg-light"
            >
              <pre
                id="transcript-content"
                class="small mb-0"
                style="display: none; white-space: pre-wrap;"
              ></pre>
              <div
                id="transcript-chat"
                class="small"
                style="display: none;"
              ></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer flex-column align-items-stretch">
        <div
          id="transcript-audio-controls"
          class="w-100 d-flex flex-wrap align-items-center gap-2 mb-2"
        >
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            id="transcript-audio-play-all"
          >
            Play all
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary"
            id="transcript-audio-play-nosilence"
          >
            Play without silence
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="transcript-audio-pause"
          >
            Pause
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="transcript-audio-stop"
          >
            Stop
          </button>
          <div
            class="vr d-none d-md-block"
            style="height: 24px;"
          ></div>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="transcript-audio-back-10"
          >
            -10s
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="transcript-audio-back-5"
          >
            -5s
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="transcript-audio-forward-5"
          >
            +5s
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline-secondary"
            id="transcript-audio-forward-10"
          >
            +10s
          </button>
          <div class="ms-auto d-flex align-items-center gap-1">
            <label
              for="transcript-audio-speed"
              class="small mb-0"
            >
              Speed
            </label>
            <select
              id="transcript-audio-speed"
              class="form-select form-select-sm"
              style="width: auto; min-width: 80px;"
            >
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
            </select>
          </div>
        </div>
        <div class="w-100 d-flex justify-content-end">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  main.container {
    max-width: 95%;
  }

  .recordings-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 576px) {
    .recordings-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 992px) {
    .recordings-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1400px) {
    .recordings-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (min-width: 1800px) {
    .recordings-grid {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  .recording-card {
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    overflow: hidden;
    transition: all 0.2s ease;
    background: var(--card-bg);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
  }

  .recording-card.selected {
    border-color: var(--purple-start);
    border-width: 2px;
    box-shadow: 0 0 0 3px var(--accent-soft-20);
  }

  .recording-card-checkbox {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    z-index: 20;
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .recording-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px var(--accent-soft-30);
    border-color: var(--purple-start);
  }

  .recording-card-header {
    padding: 0;
    background: linear-gradient(135deg, var(--purple-start) 0%, var(--purple-end) 100%);
    position: relative;
    height: 80px;
    overflow: hidden;
  }

  .recording-card-waveform {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .recording-card-title {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    z-index: 10;
  }

  .recording-card-body {
    padding: 1rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .recording-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .recording-info-item {
    display: flex;
    flex-direction: column;
  }

  .recording-info-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: var(--text-secondary);
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }

  .recording-info-value {
    font-size: 0.9rem;
    color: var(--text-primary);
    font-weight: 500;
  }

  .recording-card-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-color);
  }

  .recording-card-actions .btn {
    flex: 1;
    font-size: 0.8rem;
    padding: 0.4rem 0.5rem;
  }

  .recording-card-actions .dropdown {
    flex: 0 0 auto;
  }

  .recording-card-actions .dropdown-toggle {
    padding: 0.4rem 0.75rem;
  }

  #transcript-modal .transcript-layout {
    display: grid;
    grid-template-columns: 80px minmax(0, 1fr);
    grid-template-rows: auto minmax(0, 1fr);
    grid-template-areas:
      "controls controls"
      "timeline content";
    column-gap: 1rem;
    row-gap: 0.75rem;
    height: 70vh;
    max-height: 70vh;
  }

  #transcript-modal #transcript-controls {
    grid-area: controls;
  }

  #transcript-modal .transcript-timeline {
    grid-area: timeline;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    min-height: 0;
  }

  #transcript-modal #transcript-waveform {
    position: relative;
    width: 80px;
    height: 100%;
    min-height: 200px;
    background: linear-gradient(135deg, var(--purple-start) 0%, var(--purple-end) 100%);
    overflow: hidden;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
  }

  #transcript-modal #transcript-waveform-inner {
    height: 80px;
    transform-origin: top left;
    transform: rotate(90deg) translateY(-100%);
    flex-shrink: 0; /* keep full length after rotation */
  }

  #transcript-modal .transcript-waveform-timeline {
    position: absolute;
    inset: 0;
  }

  #transcript-modal .transcript-waveform-marker {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    margin-top: -1px; /* center the line on the position */
    background-color: var(--text-primary);
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
    pointer-events: none;
  }

  #transcript-modal #transcript-waveform ::part(region) {
    background-color: var(--accent-soft-15);
    border: 1px solid var(--accent-soft-50);
    box-sizing: border-box;
  }

  #transcript-modal #transcript-waveform ::part(region-content) {
    display: none;
  }

  #transcript-modal .transcript-waveform-segment.active {
    outline: 2px solid var(--purple-start);
    box-shadow: inset 0 0 0 1px var(--accent-soft-30);
  }

  #transcript-modal .transcript-segment-highlight {
    outline: 2px solid var(--purple-start);
    box-shadow: inset 0 0 0 1px var(--accent-soft-15);
  }

  #transcript-modal .transcript-content-cell {
    grid-area: content;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  #transcript-modal #transcript-content-scroll {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
  }
</style>
<script src="/static/node_modules/wavesurfer.js/dist/wavesurfer.min.js"></script>
<script src="/static/node_modules/wavesurfer.js/dist/plugins/regions.min.js"></script>
<script type="module">
  import WaveSurfer from '/static/node_modules/wavesurfer.js/dist/wavesurfer.esm.js';
  import Regions from '/static/node_modules/wavesurfer.js/dist/plugins/regions.esm.js';
  
  document.addEventListener('DOMContentLoaded', () => {
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.tagName === 'WAVESURFER') {
            initWaveSurfer(node);
          }
          if (node.querySelectorAll) {
            node.querySelectorAll('wavesurfer').forEach(initWaveSurfer);
          }
        });
      });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
    
    document.querySelectorAll('wavesurfer').forEach(initWaveSurfer);
  });
  
  function initWaveSurfer(el) {
    if (el._wavesurfer) return;
    
    const rootStyles = getComputedStyle(document.documentElement);
    const defaultWaveColor =
      (rootStyles.getPropertyValue("--overlay2") || "").trim() || "#ddd";
    const defaultProgressColor =
      (rootStyles.getPropertyValue("--text-primary") || "").trim() || "#999";

    const options = {
      container: el,
      height: parseInt(el.dataset.height) || 128,
      waveColor: el.dataset.waveColor || defaultWaveColor,
      progressColor: el.dataset.progressColor || defaultProgressColor,
      cursorWidth: parseInt(el.dataset.cursorWidth) || 1,
      barWidth: parseInt(el.dataset.barWidth) || 2,
      barGap: parseInt(el.dataset.barGap) || 1,
      barRadius: parseInt(el.dataset.barRadius) || 2,
      interact: el.dataset.interact !== 'false',
      url: el.dataset.url
    };
    
    const ws = WaveSurfer.create(options);
    el._wavesurfer = ws;
    
    if (el.dataset.plugins && el.dataset.plugins.includes('regions')) {
      const regionsPlugin = ws.registerPlugin(Regions.create());
      
      if (el.dataset.regionsRegions) {
        try {
          const regions = JSON.parse(el.dataset.regionsRegions);
          ws.on('ready', () => {
            regions.forEach(region => regionsPlugin.addRegion(region));
          });
        } catch (e) {
          console.error('Failed to parse regions data', e);
        }
      }
    }
  }
</script>
<script src="/static/js/recordings.js"></script>
{% endblock %}
